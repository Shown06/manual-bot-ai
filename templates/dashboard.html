{% extends "base.html" %}
{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - Manual Bot AI{% endblock %}
{% block content %}
<div class="header">
    <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p>{{ user.email }} | ãƒ—ãƒ©ãƒ³: {{ user.plan | upper }}</p>
    <div class="nav">
        <a href="/dashboard">ãƒ›ãƒ¼ãƒ </a>
        <a href="/pricing">æ–™é‡‘ãƒ—ãƒ©ãƒ³</a>
        <a href="/logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
</div>

<div class="card">
    <h2>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <form action="/upload" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <input type="file" name="file" accept=".pdf,.docx,.txt" required>
        </div>
        <button type="submit" class="btn">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
    </form>
</div>

<div class="card">
    <h2>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</h2>
    <table class="table">
        <thead>
            <tr>
                <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                <th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th>
                <th>ã‚µã‚¤ã‚º</th>
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
            <tr>
                <td>{{ file.filename }}</td>
                <td>{{ file.uploaded_at }}</td>
                <td>{{ file.file_size }} bytes</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3">ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h2>ä»Šæœˆã®ä½¿ç”¨çŠ¶æ³</h2>
    {% if usage %}
    <p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: {{ usage.files_uploaded }}å›</p>
    <p>APIå‘¼ã³å‡ºã—: {{ usage.api_calls_made }}å›</p>
    <p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡: {{ usage.messages_sent }}å›</p>
    {% else %}
    <p>ã¾ã ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“</p>
    {% endif %}
</div>

<div class="card">
    <h2>ğŸ¤– LINE Bot è‡ªå‹•é€£æº</h2>
    
    {% if line_accounts %}
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
        <h3 style="margin: 0 0 10px 0;">âœ… é€£æºæ¸ˆã¿</h3>
        <p style="margin: 0; opacity: 0.9;">LINEã§ã„ã¤ã§ã‚‚è³ªå•ã§ãã¾ã™ï¼</p>
    </div>
    {% else %}
    <div style="background: #f8fafc; padding: 30px; border-radius: 12px; text-align: center;">
        <h3 style="color: #1a202c; margin-bottom: 20px;">ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é€£æºé–‹å§‹</h3>
        
        <div id="linkingStatus" style="margin: 20px 0;">
            <button onclick="startLineLinking()" class="btn" style="font-size: 18px; padding: 15px 40px;">
                LINE Botã¨é€£æºã™ã‚‹ ğŸš€
            </button>
        </div>
        
        <div id="linkCodeDisplay" style="display: none; margin-top: 30px;">
            <p style="color: #4a5568; margin-bottom: 15px; font-size: 16px;">
                â‘  ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦LINE Botã‚’å‹ã ã¡è¿½åŠ 
            </p>
            <a id="lineAddFriendUrl" href="#" target="_blank" class="btn" style="background: #06c755; display: inline-block; text-decoration: none; margin-bottom: 20px;">
                ğŸ“± LINE Bot å‹ã ã¡è¿½åŠ 
            </a>
            
            <p style="color: #4a5568; margin: 20px 0; font-size: 16px;">
                â‘¡ å‹ã ã¡è¿½åŠ å¾Œã€ä»¥ä¸‹ã®é€£æºã‚³ãƒ¼ãƒ‰ã‚’LINEã§é€ä¿¡
            </p>
            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #667eea; margin: 20px 0;">
                <div style="font-size: 48px; font-weight: bold; color: #667eea; letter-spacing: 12px;" id="linkCode">----</div>
            </div>
            <p style="color: #718096; font-size: 14px;">æœ‰åŠ¹æœŸé™: 10åˆ†é–“</p>
            
            <div style="margin-top: 20px; padding: 15px; background: #edf2f7; border-radius: 8px;">
                <p style="color: #2d3748; margin: 0; font-size: 14px;">
                    ğŸ’¡ ãƒ’ãƒ³ãƒˆ: LINEã®ãƒˆãƒ¼ã‚¯ç”»é¢ã§ã€Œ<span id="linkCodeCopy" style="font-weight: bold;">----</span>ã€ã¨é€ä¿¡ã—ã¦ãã ã•ã„
                </p>
            </div>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #fff5f5; border-left: 4px solid #fc8181; border-radius: 4px; text-align: left;">
            <h4 style="margin: 0 0 10px 0; color: #c53030;">âš¡ï¸ è‡ªå‹•é€£æºã®ä»•çµ„ã¿</h4>
            <ul style="margin: 0; padding-left: 20px; color: #742a2a;">
                <li>é€£æºã‚³ãƒ¼ãƒ‰ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™</li>
                <li>LINEã§ç•ªå·ã‚’é€ä¿¡ã™ã‚‹ã ã‘ã§é€£æºå®Œäº†</li>
                <li>ã™ãã«AIãƒãƒ£ãƒƒãƒˆãŒä½¿ãˆã¾ã™</li>
            </ul>
        </div>
    </div>
    {% endif %}
</div>

<script>
async function startLineLinking() {
    try {
        const response = await fetch('/api/generate_link_code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // é€£æºã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            document.getElementById('linkCode').textContent = data.code;
            document.getElementById('linkCodeCopy').textContent = data.code;
            
            // LINE Botå‹ã ã¡è¿½åŠ URLã‚’è¨­å®š
            const lineAddUrl = 'https://line.me/R/ti/p/@415fibwz';
            document.getElementById('lineAddFriendUrl').href = lineAddUrl;
            
            // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('linkingStatus').style.display = 'none';
            document.getElementById('linkCodeDisplay').style.display = 'block';
            
            // è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆé€£æºå®Œäº†ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
            checkLinkingStatus(data.code);
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
    } catch (error) {
        console.error('Link code error:', error);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

function checkLinkingStatus(code) {
    // 5ç§’ã”ã¨ã«é€£æºçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    const intervalId = setInterval(async () => {
        try {
            const response = await fetch('/api/check_linking_status');
            const data = await response.json();
            
            if (data.linked) {
                clearInterval(intervalId);
                // é€£æºå®Œäº†ã‚’è¡¨ç¤º
                document.getElementById('linkCodeDisplay').innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 12px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 24px;">âœ… é€£æºå®Œäº†ï¼</h3>
                        <p style="margin: 0; font-size: 16px; opacity: 0.9;">LINEã§ãƒãƒ‹ãƒ¥ã‚¢ãƒ«Botã«è³ªå•ã§ãã¾ã™</p>
                    </div>
                `;
                // 3ç§’å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰
                setTimeout(() => location.reload(), 3000);
            }
        } catch (error) {
            console.error('Status check error:', error);
        }
    }, 5000);
    
    // 10åˆ†å¾Œã«è‡ªå‹•åœæ­¢
    setTimeout(() => clearInterval(intervalId), 600000);
}
</script>
{% endblock %}
